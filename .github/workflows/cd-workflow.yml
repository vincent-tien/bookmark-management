name: cd-pipeline
on:
  workflow_run:
    workflows: ["ci-pipeline"]
    types: ["completed"]

jobs:
  deploy:
    # Deploy khi ci-pipeline thành công và branch là main
    # Điều này bao gồm cả:
    # - Push trực tiếp vào main (github.event.workflow_run.event == 'push')
    # - PR được merge vào main (merge tạo push event vào main, trigger ci-pipeline với event 'push')
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main' &&
      github.event.workflow_run.event == 'push'

    runs-on: [ self-hosted ]

    steps:
      - name: Deploy bookmark service
        working-directory: /root/bookmark-management/deployment
        run: |
          docker-compose pull bookmark_service
          docker-compose up -d bookmark_service
          docker system prune -f